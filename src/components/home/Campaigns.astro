---
import CampaignCard from "./CampaignCard.svelte";
import type { Campaign } from "../../types/campaign";
import ArrowRightIcon from "../../svgs/ArrowRightIcon.svelte";
import { apiProjectsGetCollection, type Accounting, type Money } from "../../openapi/client";
import { getLanguage } from "../../middleware/utils";
import { client } from "../../openapi/client/client.gen";

const { t } = Astro.locals;

const highlightedProjects = {
    "todos-somos-gaza": "https://www.goteo.org/img/780x478/caratula-43.png",
    "fons-comunitari-per-la-dana-resposta-collectiva-pe":
        "https://www.goteo.org/img/780x478/1-1823.jpg",
    "espana-en-llamas":
        "https://www.goteo.org/img/700x0/captura-de-pantalla-20120813-a-las-1.35.23-am.png",
    "menus-solidarios": "https://www.goteo.org/img/780x478/chefsforukraine-poland-6.jpeg",
    "sindicat-de-llogaters-i-llogateres": "https://ca.goteo.org/img/780x478/banner-goteo-17.jpg",
};

const { data: projects } = await apiProjectsGetCollection({
    headers: { "Accept-Language": getLanguage(Astro) },
    query: {
        "slug[]": Object.keys(highlightedProjects),
    },
});

const campaigns: Campaign[] = await Promise.all(
    projects!.map(async (project, index) => {
        const { data: accounting } = (await client.get({
            url: client.buildUrl({ url: project.accounting! }),
        })) as { data: Accounting };

        return {
            size: index < 1 ? "large" : "small",
            id: project.slug!,
            title: project.title!,
            image:
                highlightedProjects[project.slug! as keyof typeof highlightedProjects] ||
                project.video?.thumbnail!,
            minimum: project.budget?.minimum?.money!,
            obtained: accounting!.balance as Money,
            optimum: project.budget?.optimum?.money,
        };
    }),
);

// Smart grid layout logic:
// - Max grid is 2 rows x 3 columns = 6 slots
// - Large cards take 2 slots, small cards take 1 slot
// - We need to calculate how many campaigns fit within 6 slots
function selectCampaignsForGrid(campaigns: Campaign[], maxSlots: number = 6): Campaign[] {
    const selectedCampaigns: Campaign[] = [];
    let usedSlots = 0;

    for (const campaign of campaigns) {
        const slotsNeeded = campaign.size === "large" ? 2 : 1;

        // Check if we can fit this campaign in the remaining slots
        if (usedSlots + slotsNeeded <= maxSlots) {
            selectedCampaigns.push(campaign);
            usedSlots += slotsNeeded;
        } else {
            // Can't fit more campaigns
            break;
        }
    }

    return selectedCampaigns;
}

const displayCampaigns = selectCampaignsForGrid(campaigns);
---

<section class="wrapper">
    <!-- Header Section -->
    <div class="mb-6 flex items-center justify-between">
        <h2 class="text-2xl font-bold text-black">
            {t("home.campaigns.title")}
        </h2>

        <!-- "Ver todas" Button -->
        <button
            class="bg-variant1 flex items-center gap-2 rounded-3xl px-6 py-4 transition-all duration-200 hover:opacity-90"
        >
            <!-- Arrow Icon -->
            <ArrowRightIcon />
            <span class="text-secondary text-base font-bold">
                {t("home.campaigns.viewAll")}
            </span>
        </button>
    </div>

    <!-- Campaigns Grid: 3 columns max, 2 rows, large cards take 2 columns -->
    <div class="grid auto-rows-fr grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
        {
            displayCampaigns.map((campaign) => (
                <CampaignCard size={campaign.size} campaign={campaign} />
            ))
        }
    </div>
</section>
