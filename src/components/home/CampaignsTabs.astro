---
import CampaignCard from "./CampaignCard.svelte";
import Carousel from "../Carousel.svelte";
import CampaignsTabsNav from "./CampaignsTabsNav.svelte";
import type { Campaign } from "../../types/campaign";
import {
    apiProjectsGetCollection,
    type Accounting,
    type ApiAccountingsIdGetData,
    type Money,
} from "../../openapi/client";
import { getLanguage } from "../../middleware/utils";
import { client } from "../../openapi/client/client.gen";

const { t } = Astro.locals;
const chosenProjects = {
    "impulsa-la-cooperativa-de-informacion-climatica": "",
    "fons-cooperatiu-front-l-emergencia-social-i-sanita": "",
    "la-benefica":
        "https://i.vimeocdn.com/video/1286954665-1fc1ccfa1b381946d23072ca518e4f0094c566416243095e6_900x500?region=us",
};

// Mock campaign data - using same campaigns as the main Campaigns component
const { data: projects } = await apiProjectsGetCollection({
    query: {
        "slug[]": Object.keys(chosenProjects),
    },
    headers: {
        "Accept-Language": getLanguage(Astro.url.pathname, Astro.request, Astro.cookies),
    },
});

const campaigns: Campaign[] = await Promise.all(
    projects!.map(async (project) => {
        const { data: accounting } = (await client.get({
            url: client.buildUrl({ url: project.accounting! }),
        })) as { data: Accounting };

        return {
            size: "small",
            id: project.slug!,
            title: project.title!,
            image:
                chosenProjects[project.slug! as keyof typeof chosenProjects] ||
                project.video?.thumbnail!,
            minimum: project.budget?.minimum?.money!,
            optimum: project.budget?.optimum?.money,
            obtained: accounting!.balance as Money,
        };
    }),
);

// Get campaigns for the currently active tab
const displayCampaigns = campaigns.slice(0, 4); // Show first 4 campaigns
---

<section class="wrapper flex flex-col gap-6">
    <!-- Header Section -->
    <div class="flex items-center justify-start">
        <h2 class="text-2xl font-bold text-black">{t("home.campaigns.tabsTitle")}</h2>
    </div>

    <!-- Tab Navigation using shared Tabs component -->
    <div class="mx-auto">
        <CampaignsTabsNav client:load />
    </div>

    <!-- Campaigns Carousel -->
    <div>
        <Carousel client:load itemsPerGroup={3} gap={24} showDots={false}>
            {displayCampaigns.map((campaign) => <CampaignCard size="small" campaign={campaign} />)}
        </Carousel>
    </div>
</section>
