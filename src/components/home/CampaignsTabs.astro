---
import CampaignCard from "./CampaignCard.astro";
import Carousel from "../Carousel.svelte";
import type { Campaign } from "../../types/campaign";
import ClockIcon from "../../svgs/ClockIcon.svelte";
import MatchFundingIcon from "../../svgs/MatchFundingIcon.astro";
import FlashIcon from "../../svgs/FlashIcon.astro";
import { apiProjectsGetCollection, type Accounting, type ApiAccountingsIdGetData, type ApiMoney } from "../../openapi/client";
import { getLanguage } from "../../middleware/utils";
import { client } from "../../openapi/client/client.gen";

const { t } = Astro.locals;

// Mock campaign data - using same campaigns as the main Campaigns component
const { data: projects } = await apiProjectsGetCollection({
    query: {
        "slug[]": [
            "impulsa-la-cooperativa-de-informacion-climatica",
            "fons-cooperatiu-front-l-emergencia-social-i-sanita",
            "la-benefica"
        ]
    },
    headers: {
        "Accept-Language": getLanguage(Astro)
    }
});

const mockCampaigns: Campaign[] = await Promise.all(projects!.map(async (project) => {
    const { data: accounting } = await client.get({ url: client.buildUrl({ url: project.accounting! })}) as { data: Accounting};

    return {
        size: "small",
        id: project.slug!,
        title: project.title!,
        image: project.video?.thumbnail!,
        minimum: project.budget?.minimum?.money!,
        obtained: accounting!.balance as ApiMoney
    }
}));

// Get campaigns for the currently active tab
const displayCampaigns = mockCampaigns.slice(0, 4); // Show first 4 campaigns
---

<section class="wrapper flex flex-col gap-6">
    <!-- Header Section -->
    <div class="flex items-center justify-start">
        <h2 class="text-2xl font-bold text-black">{t("home.campaigns.tabsTitle")}</h2>
    </div>

    <!-- Tab Navigation -->
    <div class="mx-auto flex items-center justify-between">
        <div class="flex items-center gap-0">
            <!-- Active Tab: Acaban pronto -->
            <button
                class="border-primary flex items-center gap-2 rounded-t-lg border-b-2 px-6 py-2 transition-all duration-200"
                data-tab="ending-soon"
            >
                <FlashIcon width="16" height="16" class="h-4 w-4" />
                <span class="text-tertiary text-base font-bold"
                    >{t("home.campaigns.tabs.mostSuccessful")}</span
                >
            </button>

            <!-- Inactive Tab: MÃ¡s exitosas -->
            <!-- <button
                class="border-purple-tint flex items-center gap-2 rounded-t-lg border-b-2 px-6 py-2 transition-all duration-200"
                data-tab="most-successful"
            >
                <FlashIcon width="16" height="16" class="h-4 w-4" />
                <span class="text-secondary text-base font-bold"
                    >{t("home.campaigns.tabs.mostSuccessful")}</span
                >
            </button> -->

            <!-- Inactive Tab: Con Matchfunding -->
            <!-- <button
                class="border-purple-tint flex items-center gap-2 rounded-t-lg border-b-2 px-6 py-2 transition-all duration-200"
                data-tab="matchfunding"
            >
                <MatchFundingIcon width="16" height="16" class="h-4 w-4" />
                <span class="text-secondary text-base font-bold">
                    {t("home.campaigns.tabs.withMatchfunding")}
                </span>
            </button> -->
        </div>
    </div>

    <!-- Campaigns Carousel -->
    <div>
        <Carousel client:load itemsPerGroup={3} gap={24} showDots={false}>
            {displayCampaigns.map((campaign) => <CampaignCard size="small" campaign={campaign} />)}
        </Carousel>
    </div>
</section>

<script>
    // Tab switching functionality
    const tabs = document.querySelectorAll("[data-tab]") as NodeListOf<HTMLButtonElement>;

    tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
            // Remove active state from all tabs
            tabs.forEach((t) => {
                t.classList.remove("border-primary");
                t.classList.add("border-purple-tint");
                const span = t.querySelector("span");
                if (span) span.classList.remove("text-tertiary");
                if (span) span.classList.add("text-secondary");
            });

            // Add active state to clicked tab
            tab.classList.add("border-primary");
            tab.classList.remove("border-purple-tint");
            const span = tab.querySelector("span");
            if (span) span.classList.add("text-tertiary");
            if (span) span.classList.remove("text-secondary");

            // Here you would typically fetch/filter campaigns based on the selected tab
            const tabType = tab.getAttribute("data-tab");
            console.log("Selected tab:", tabType);
        });
    });
</script>
