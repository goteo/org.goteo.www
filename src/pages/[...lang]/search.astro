---
import Layout from "../../layouts/Layout.astro";
import SearchFilters from "../../components/search/SearchFilters.svelte";
import SearchResultsClient from "../../components/search/SearchResultsClient.svelte";
import { projectsService } from "../../services/projectsService";

import type { Project } from "../../openapi/client/types.gen";

const { t, lang } = Astro.locals;

// Get initial projects from API (for SSR)
let initialProjects: Project[] = [];

try {
    // Fetch initial projects from API
    initialProjects = await projectsService.getInitialProjects(lang, {
        limit: 12, // Standard page size
    });
} catch (error) {
    // Empty array on failure - component handles empty state
    console.error("Failed to load initial projects:", error);
    initialProjects = [];
}

// Parse URL search parameters for SSR
const url = new URL(Astro.request.url);
const initialFilters = {
    query: url.searchParams.get("q") || "",
    statusFilter: url.searchParams.get("status") || "",
    categories: url.searchParams.get("categories")?.split(",").filter(Boolean) || [],
};

// Check if URL has search parameters
const hasInitialSearch = !!(
    initialFilters.query ||
    initialFilters.statusFilter ||
    initialFilters.categories.length > 0
);
---

<Layout title={t("search.title")} description={t("search.description")}>
    <section class="wrapper">
        <!-- Page Header -->
        <div class="mb-12 text-center">
            <h1 class="text-tertiary mb-4 text-4xl font-bold">
                {t("search.heading")}
            </h1>
            <p class="text-secondary text-lg">
                {t("search.subtitle")}
            </p>
        </div>

        <!-- Search Filters -->
        <div class="mb-8">
            <SearchFilters locale={lang} initialFilters={initialFilters} client:load />
        </div>

        <!-- Search Results -->
        <div class="mb-8" role="region" aria-label={t("search.results.regionLabel")}>
            <SearchResultsClient
                initialProjects={initialProjects}
                initialFilters={initialFilters}
                hasInitialSearch={hasInitialSearch}
                client:load
            />
        </div>
    </section>
</Layout>
