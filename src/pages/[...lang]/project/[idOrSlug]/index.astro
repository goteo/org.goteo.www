---
import SingleProject from "../../../../components/project/SingleProject.svelte";
import Layout from "../../../../layouts/Layout.astro";
import {
    apiAccountingBalancePointsGetCollection,
    apiAccountingsIdGet,
    apiProjectsIdOrSlugGet,
    apiProjectSupportsGetCollection,
    apiUsersIdGet,
    type Project,
} from "../../../../openapi/client";
import { extractId } from "../../../../utils/extractId";

const { idOrSlug } = Astro.params;

if (!idOrSlug) {
    throw new Error("Project ID or Project Slug is undefined.");
}

let lang = Astro.locals.lang;

const { data: project, error } = await apiProjectsIdOrSlugGet({
    path: { idOrSlug },
    headers: { "Accept-Language": lang },
});

if (error || typeof project === "undefined") {
    throw new Error("Project not found");
}

const accountingId = extractId(project?.accounting)!;
const { data: accounting } = await apiAccountingsIdGet({ path: { id: accountingId } });
const { data: owner } = await apiUsersIdGet({ path: { id: extractId(project.owner)! } });

const { data: supports } = await apiProjectSupportsGetCollection({
    query: { project: String(project.id!) },
    headers: { Accept: "application/ld+json" },
});

// @ts-ignore
const totalSupports = supports.totalItems;

const deadlineKey = project?.deadline as keyof Project["calendar"];
const deadline = new Date(project?.calendar?.[deadlineKey]!);
deadline.setDate(deadline.getDate() + 1);

const { data: balancePoints } = await apiAccountingBalancePointsGetCollection({
    query: {
        accounting: project?.accounting ?? "",
        start: project?.calendar?.release ?? "",
        end: deadline.toISOString(),
        aggregate: true,
    },
});
---

<Layout title={project.title} description={project.description}>
    <SingleProject
        {lang}
        {project}
        accounting={accounting!}
        owner={owner!}
        {totalSupports}
        {balancePoints}
        client:load
    />
</Layout>
