---
import Layout from "../../../layouts/Layout.astro";
import { apiAccountingsIdGet, apiGatewayCheckoutsIdGet, apiProjectsIdOrSlugGet, apiProjectSupportsGetCollection } from "../../../openapi/client";
import FeedbackForm from "../../../components/Checkout/FeedbackForm.svelte";
import Steps from "../../../components/Checkout/Steps.svelte";
import Summary from "../../../components/Checkout/Summary.svelte";
import ApprovedIcon from "../../../svgs/ApprovedIcon.astro";
import PaymentErrorIcon from "../../../svgs/PaymentErrorIcon.astro";
import PaymentMethod from "../../../components/Checkout/PaymentMethod.astro";
import { apiGatewaysGetCollection } from "../../../openapi/client/index";
import { getDefaultCurrency } from "../../../utils/consts.ts";
import { extractId } from "../../../utils/extractId";
import type { Campaign } from "../../../types/campaign";
import SupportedProjectCard from "../../../components/Checkout/SupportedProjectCard.svelte";
import GoalFeedbackForm from "../../../components/Checkout/GoalFeedbackForm.svelte";

const defaultCurrency = getDefaultCurrency();

const { data: paymentGateways } = await apiGatewaysGetCollection();

const accessCookie = Astro.cookies.get("access-token");

if (!accessCookie) {
    throw new Error("Token not found");
}

const { accountingId, token } = JSON.parse(accessCookie.value);
const { data: accounting } = await apiAccountingsIdGet({
    path: { id: accountingId },
    headers: {
        Authorization: `Bearer ${token}`,
    },
});

const { t } = Astro.locals;

let error = null;
let amount: number | undefined = undefined;
let projects: Campaign[] = [];

try {
    const url = new URL(Astro.request.url);
    const checkoutId = url.searchParams.get("checkoutId");

    if (!checkoutId) {
        throw new Error("Checkout ID not found");
    }

    const response = await apiGatewayCheckoutsIdGet({
        path: { id: checkoutId },
        headers: {
            Authorization: `Bearer ${token}`,
        },
    });

    if (!response.data) {
        throw new Error("Data not found");
    }

    amount = response.data?.charges?.reduce((sum, charge) => sum + (charge.money.amount ?? 0), 0);

    if (response.data.charges?.length) {
        // Fetch unique projects from all charges
        const projectIds = new Set<string>();
        
        for (const charge of response.data.charges) {
            const targetAccountingIri = charge.target;
            const targetAccountingId = extractId(targetAccountingIri);
            
            if (targetAccountingId) {
                 const { data: projAccounting } = await apiAccountingsIdGet({ path: { id: targetAccountingId } });
                 const projectIri = projAccounting.owner;
                 const projectId = extractId(projectIri);
                 if (projectId) {
                     projectIds.add(projectId);
                 }
            }
        }

        for (const projectId of projectIds) {
             const { data: projectData } = await apiProjectsIdOrSlugGet({ path: { idOrSlug: projectId } });

            if (projectData) {
                // We need the accounting balance for "obtained" amount
                // Since we might have multiple charges for the same project, or different projects
                // we need to find the accounting for this project again. 
                // Optimization: We could cache accountings above, but for now this is safe.
                // Actually, the projectData has 'accounting' IRI.
                const accountingId = extractId(projectData.accounting);
                let balance = { amount: 0, currency: defaultCurrency };
                
                if (accountingId) {
                     const { data: acc } = await apiAccountingsIdGet({ path: { id: accountingId } });
                     if (acc.balance) balance = acc.balance;
                }

                const now = new Date();
                let endDateStr = projectData.calendar?.minimum;
                if (projectData.deadline === 'optimum') {
                    endDateStr = projectData.calendar?.optimum;
                }
                let daysRemaining = 0;
                if (endDateStr) {
                    const endDate = new Date(endDateStr);
                    const diffTime = endDate.getTime() - now.getTime();
                    daysRemaining = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                }

                // Ensure we have valid money objects with defaults
                const defaultMoney = { amount: 0, currency: defaultCurrency };

                let projectSupport = null;
                if (response.data.origin) {
                    try {
                        const projectIri = projectData['@id'] || `/v4/projects/${projectData.id}`;
                        const { data: supports } = await apiProjectSupportsGetCollection({
                            query: {
                                project: projectIri,
                                origin: response.data.origin
                            },
                            headers: {
                                Authorization: `Bearer ${token}`,
                            }
                        });
                        if (supports && supports.length > 0) {
                            projectSupport = supports[0];
                        }
                    } catch (e) {
                        console.error("Error fetching project support", e);
                    }
                }

                projects.push({
                    ...projectData,
                    slug: projectData.slug || "",
                    title: projectData.title,
                    image: (projectData as any).image || (projectData as any).imageUrl || (projectData as any).cover || "",
                    obtained: balance || defaultMoney,
                    minimum: projectData.budget?.minimum?.money || defaultMoney,
                    optimum: projectData.budget?.optimum?.money || defaultMoney,
                    daysRemaining: daysRemaining > 0 ? daysRemaining : 0,
                    category: projectData.categories?.[0] || "general",
                    tags: [],
                    hasMatchfunding: false,
                    projectSupport: projectSupport
                });
            }
        }
    }

} catch (err) {
    console.error("Error trying to get payment status", err);
    error = err instanceof Error ? err.message : "Unknown error";
}

const checkoutId = new URL(Astro.request.url).searchParams.get("checkoutId");
const postPaymentUrl = checkoutId
    ? `/payment/post-payment?checkoutId=${checkoutId}`
    : "/payment/post-payment";
---

<Layout title="Estado del pago">
    <main class="wrapper py-10">
        {
            error ? (
                <main class="wrapper">
                    <div class="flex flex-row gap-8 py-10">
                        <div class="flex w-1/2 flex-col gap-10">
                            <div class="flex flex-col gap-4">
                                <div class="flex flex-col gap-10">
                                    <div class="flex flex-row items-center justify-between gap-6">
                                        <div class="flex w-2/3 flex-col gap-4">
                                            <h2 class="text-[40px]/[48px] font-bold tracking-[0%] text-black">
                                                {t("payment.page-error.title")}
                                            </h2>
                                            <p class="text-content">
                                                {t("payment.page-error.description")}
                                            </p>
                                        </div>
                                        <PaymentErrorIcon />
                                    </div>

                                    <PaymentMethod
                                        {paymentGateways}
                                        {accounting}
                                        hasError={!!error}
                                    />
                                </div>
                            </div>
                        </div>
                        <div class="border-secondary sticky top-10 flex h-fit w-1/2 flex-col gap-6 rounded-[40px] border bg-white">
                            <div class="flex flex-col gap-4 px-6 pt-6 pb-6">
                                <p class="text-content text-sm">{t("checkout.summary.deduct")}</p>
                                <a
                                    href={postPaymentUrl}
                                    class="bg-primary text-secondary w-fit cursor-pointer rounded-3xl px-6 py-4 font-bold"
                                >
                                    {t("global.btn.continue")}
                                </a>
                            </div>
                        </div>
                    </div>
                </main>
            ) : (
                <>
                    <main class="wrapper">
                        <div class="flex flex-row gap-8 py-10">
                            <div class="flex w-1/2 flex-col gap-10">
                                <div class="flex flex-col gap-4">
                                    <div class="flex flex-col gap-10">
                                        <div class="flex flex-row items-center justify-between gap-6">
                                            <div class="flex w-2/3 flex-col gap-4">
                                                <h2 class="text-[40px]/[48px] font-bold tracking-[0%] text-black">
                                                    {t("payment.page-aproved.title")}
                                                </h2>
                                                <p class="text-content">
                                                    {t("payment.page-aproved.description")}
                                                </p>
                                            </div>
                                            <ApprovedIcon />
                                        </div>
                                        <div>
                                            <GoalFeedbackForm client:load />
                                        </div>
                                        
                                        <div class="inline-flex flex-col justify-start items-start gap-6 mt-10">
                                            <div class="w-96 flex flex-col justify-start items-start gap-10">
                                                <div class="self-stretch flex flex-col justify-start items-start gap-4">
                                                    <div class="self-stretch justify-start text-neutral-700 text-2xl font-bold font-['Karla'] leading-8">
                                                        Deja un mensaje en los proyectos a los que has apoyado
                                                    </div>
                                                    <div class="self-stretch justify-start text-zinc-600 text-base font-normal font-['Karla'] leading-6">
                                                        Tu donación se verá reflejada en los proyectos que has apoyado. Puedes dejar un mensaje o permanecer en el anonimato.
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex flex-col justify-start items-start gap-4 w-full">
                                                {projects.map(project => (
                                                    <SupportedProjectCard project={project} token={token} client:load />
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="border-secondary sticky top-10 flex h-fit w-1/2 flex-col gap-6 rounded-[40px] border bg-white">
                                <div class="flex flex-col gap-4 px-6 pt-6 pb-6">
                                    <p class="text-content text-sm">
                                        {t("checkout.summary.deduct")}
                                    </p>
                                    <a
                                        href={postPaymentUrl}
                                        class="bg-primary text-secondary w-fit cursor-pointer rounded-3xl px-6 py-4 font-bold"
                                    >
                                        {t("global.btn.continue")}
                                    </a>
                                </div>
                            </div>
                        </div>
                    </main>
                    <script>import {cart} from "../../../stores/cart"; cart.clear();</script>
                </>
            )
        }
    </main>
</Layout>
