---
import Layout from "../../../layouts/Layout.astro";
import { apiAccountingsIdGet, apiGatewayCheckoutsIdGet } from "../../../openapi/client";
import FeedbackForm from "../../../components/Checkout/FeedbackForm.svelte";
import Steps from "../../../components/Checkout/Steps.svelte";
import Summary from "../../../components/Checkout/Summary.svelte";
import ApprovedIcon from "../../../svgs/ApprovedIcon.astro";
import PaymentErrorIcon from "../../../svgs/PaymentErrorIcon.astro";
import PaymentMethod from "../../../components/Checkout/PaymentMethod.svelte";
import { apiGatewaysGetCollection } from "../../../openapi/client/index";
import { getDefaultCurrency } from "../../../utils/consts.ts";

const defaultCurrency = getDefaultCurrency();

const { data: paymentGateways } = await apiGatewaysGetCollection();

const accessCookie = Astro.cookies.get("access-token");

if (!accessCookie) {
    throw new Error("Token not found");
}

const { accountingId, token } = JSON.parse(accessCookie.value);
const { data: accounting } = await apiAccountingsIdGet({
    path: { id: accountingId },
    headers: {
        Authorization: `Bearer ${token}`,
    },
});

const { t } = Astro.locals;

let error = null;
let amount: number | undefined = undefined;
let selectedGateway: string | undefined = undefined;

try {
    const url = new URL(Astro.request.url);
    const checkoutId = url.searchParams.get("checkoutId");

    if (!checkoutId) {
        throw new Error("Checkout ID not found");
    }

    const response = await apiGatewayCheckoutsIdGet({
        path: { id: checkoutId },
        headers: {
            Authorization: `Bearer ${token}`,
        },
    });

    if (!response.data) {
        throw new Error("Data not found");
    }

    selectedGateway = response.data.gateway.split("/").pop();

    if (response.data.status !== "charged") {
        throw new Error("Payment not completed");
    }

    amount = response.data?.charges?.reduce((sum, charge) => sum + (charge.money.amount ?? 0), 0);
} catch (err) {
    console.error("Error trying to get payment status", err);
    error = err instanceof Error ? err.message : "Unknown error";
}

const checkoutId = new URL(Astro.request.url).searchParams.get("checkoutId");
const postPaymentUrl = checkoutId
    ? `/payment/post-payment?checkoutId=${checkoutId}`
    : "/payment/post-payment";
---

<Layout title="Estado del pago">
    <main class="wrapper py-10">
        {
            error ? (
                <main class="wrapper">
                    <div class="flex flex-col gap-8 py-10 lg:flex-row">
                        <div class="flex w-full flex-col gap-10 lg:w-1/2">
                            <div class="flex flex-col gap-4">
                                <div class="flex flex-col gap-10">
                                    <div class="flex flex-row items-center justify-between gap-6">
                                        <div class="flex w-2/3 flex-col gap-4">
                                            <h2 class="text-[40px]/[48px] font-bold tracking-[0%] text-black">
                                                {t("payment.page-error.title")}
                                            </h2>
                                            <p class="text-content">
                                                {t("payment.page-error.description")}
                                            </p>
                                        </div>
                                        <PaymentErrorIcon />
                                    </div>

                                    <PaymentMethod
                                        {paymentGateways}
                                        {accounting}
                                        hasError={!!error}
                                    />
                                </div>
                            </div>
                        </div>
                        <div class="fixed right-0 bottom-0 left-0 flex h-[320px] h-fit w-full flex-col gap-6 rounded-t-[24px] border-t border-r border-l bg-white pt-6 pr-4 pb-6 pl-4 lg:relative lg:sticky lg:top-10 lg:right-auto lg:bottom-auto lg:left-auto lg:h-fit lg:w-1/2 lg:gap-6 lg:rounded-[40px] lg:border lg:p-6">
                            <Summary client:load {defaultCurrency} {amount} hasError={!!error} />
                            <div class="lg:block" id="checkout-details">
                                <div class="flex flex-col gap-4 px-0 pt-6 pb-0 lg:px-6 lg:pt-0 lg:pb-0">
                                    <p class="text-content text-sm">
                                        {t("checkout.summary.deduct")}
                                    </p>
                                </div>
                            </div>
                            <div class="flex flex-col items-end px-0 pt-0 pb-0 lg:px-6 lg:pt-0 lg:pb-0">
                                <a
                                    href={postPaymentUrl}
                                    class="bg-primary text-secondary w-fit cursor-pointer rounded-3xl px-6 py-4 font-bold"
                                >
                                    {t("global.btn.continue")}
                                </a>
                            </div>
                        </div>
                    </div>
                </main>
            ) : (
                <>
                    <main class="wrapper">
                        <div class="flex flex-col gap-8 py-10 lg:flex-row">
                            <div class="flex w-full flex-col gap-10 lg:w-1/2">
                                <div class="flex flex-col gap-4">
                                    <div class="flex flex-col gap-9">
                                        <div class="flex flex-row items-center justify-between gap-6">
                                            <div class="flex w-2/3 flex-col gap-4">
                                                <h2 class="text-[40px]/[48px] font-bold tracking-[0%] text-black">
                                                    {t("payment.page-approved.title")}
                                                </h2>
                                                <p class="text-content">
                                                    {t("payment.page-approved.description")}
                                                </p>
                                            </div>
                                            <ApprovedIcon />
                                        </div>
                                        <div>
                                            <FeedbackForm
                                                client:load
                                                paymentMethod={selectedGateway}
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="fixed right-0 bottom-0 left-0 flex h-[320px] h-fit w-full flex-col gap-6 rounded-t-[24px] border-t border-r border-l bg-white pt-6 pr-4 pb-6 pl-4 lg:relative lg:sticky lg:top-10 lg:right-auto lg:bottom-auto lg:left-auto lg:h-fit lg:w-1/2 lg:gap-6 lg:rounded-[40px] lg:border lg:p-6">
                                <Summary
                                    client:load
                                    {defaultCurrency}
                                    {amount}
                                    hasError={!!error}
                                />
                                <div class="lg:block" id="checkout-details">
                                    <div class="flex flex-col gap-4 px-0 pt-6 pb-0 lg:px-6 lg:pt-0 lg:pb-0">
                                        <p class="text-content text-sm">
                                            {t("checkout.summary.deduct")}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end px-0 pt-0 pb-0 lg:px-6 lg:pt-0 lg:pb-0">
                                    <a
                                        href={postPaymentUrl}
                                        class="bg-primary text-secondary w-fit cursor-pointer rounded-3xl px-6 py-4 font-bold"
                                    >
                                        {t("global.btn.continue")}
                                    </a>
                                </div>
                            </div>
                        </div>
                    </main>
                    <script>import {cart} from "../../../stores/cart"; cart.clear();</script>
                </>
            )
        }
    </main>
</Layout>
