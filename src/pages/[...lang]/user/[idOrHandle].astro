---
import Layout from "../../../layouts/Layout.astro";
import ProfileHero from "../../../components/profile/ProfileHero.astro";
import ProfileInfo from "../../../components/profile/ProfileInfo.svelte";
import ProfileTabs from "../../../components/profile/ProfileTabs.svelte";
import ProfileBio from "../../../components/profile/ProfileBio.astro";
import {
    apiUsersIdGet,
    apiUsersIdpersonGet,
    apiUsersIdorganizationGet,
} from "../../../openapi/client";

import type { User, Person, Organization } from "../../../openapi/client/types.gen";

const { idOrHandle } = Astro.params;
const { t } = Astro.locals;

if (!idOrHandle) {
    return Astro.redirect("/404");
}

// Fetch user data
let user: User | undefined;
let person: Person | undefined;
let organization: Organization | undefined;
let errorMessage: string | undefined;

try {
    const userResponse = await apiUsersIdGet({
        path: { id: idOrHandle },
    });

    if (userResponse.error) {
        throw new Error("User not found");
    }

    user = userResponse.data;

    // Fetch person details for individual users
    if (user.type === "individual" && user.person) {
        const personId = user.person.split("/").pop();
        if (personId) {
            const personResponse = await apiUsersIdpersonGet({
                path: { id: personId },
            });
            if (!personResponse.error) {
                person = personResponse.data;
            }
        }
    }

    // Fetch organization details for organization users
    if (user.type === "organization" && user.organization) {
        const orgId = user.organization.split("/").pop();
        if (orgId) {
            const orgResponse = await apiUsersIdorganizationGet({
                path: { id: orgId },
            });
            if (!orgResponse.error) {
                organization = orgResponse.data;
            }
        }
    }
} catch (error) {
    console.error("Error fetching user:", error);
    errorMessage = t("profile.notFound");
}

// Prepare profile data with proper fallbacks
const displayName =
    user?.displayName ||
    (person ? `${person.firstName || ""} ${person.lastName || ""}`.trim() : "") ||
    organization?.businessName ||
    organization?.legalName ||
    user?.handle ||
    "User";

// Location - would come from user profile data in production
// API doesn't seem to have location field yet, using placeholder
const location = "Barcelona, Catalunya";

// Bio - would come from user profile description field in production
// For now using sample text if user exists
const bio =
    user && displayName !== "User"
        ? `${displayName}: ${user.type === "organization" ? t("profile.organizationIntro") : t("profile.userIntro")}

${t("profile.bioSample", { name: displayName })}`
        : undefined;

const tabs = [
    { id: "about", label: t("profile.tabs.about") },
    { id: "projects", label: t("profile.tabs.projects") },
    { id: "donorType", label: t("profile.tabs.donorType") },
];

// Social links - would come from user.socialMedia or similar field
// API doesn't seem to have social media fields yet, using sample data
const socialLinks = user
    ? {
          twitter: `https://twitter.com/${user.handle}`,
          instagram: `https://instagram.com/${user.handle}`,
          facebook: undefined,
          linkedin: undefined,
          email: user.email ? `mailto:${user.email}` : undefined,
          medium: undefined,
      }
    : {};

// Images with fallbacks
const coverImage = undefined; // API doesn't provide cover image, use default
const avatarImage = user?.avatar || undefined; // Use user avatar or default placeholder

// User stats
const projectCount = user?.projects?.length || 0;
const isVerified = user?.emailConfirmed || false;
const isActive = user?.active || false;
---

<Layout
    title={`${displayName} - ${t("metadata.title")}`}
    description={`${t("profile.tabs.about")} ${displayName}`}
>
    {
        errorMessage ? (
            <div class="flex min-h-screen items-center justify-center">
                <p class="text-xl text-[#575757]">{errorMessage}</p>
            </div>
        ) : (
            <div class="flex w-full flex-col items-center gap-10">
                {/* Hero Section with Cover and Avatar */}
                <ProfileHero coverImage={coverImage} avatarImage={avatarImage} />

                {/* User Info Section */}
                <ProfileInfo
                    displayName={displayName}
                    location={location}
                    socialLinks={socialLinks}
                    client:load
                />

                {/* Tabs Navigation */}
                <div class="mt-8 w-full">
                    <ProfileTabs tabs={tabs} client:load />
                </div>

                {/* Bio Section */}
                <ProfileBio bio={bio} />
            </div>
        )
    }
</Layout>