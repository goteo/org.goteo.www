---
import Layout from "../../../layouts/Layout.astro";
import ProfileHero from "../../../components/profile/ProfileHero.astro";
import ProfileInfo from "../../../components/profile/ProfileInfo.svelte";
import ProfileTabs from "../../../components/profile/ProfileTabs.svelte";
import ProfileBio from "../../../components/profile/ProfileBio.astro";
import { apiUsersIdGet, apiUsersIdpersonGet } from "../../../openapi/client";

const { idOrHandle } = Astro.params;
const { t } = Astro.locals;

if (!idOrHandle) {
    return Astro.redirect("/404");
}

// Fetch user data
let user;
let person;
let errorMessage;

try {
    const userResponse = await apiUsersIdGet({
        path: { id: idOrHandle },
    });

    if (userResponse.error) {
        throw new Error("User not found");
    }

    user = userResponse.data;

    // Fetch person details if available
    if (user.person) {
        const personId = user.person.split("/").pop();
        if (personId) {
            const personResponse = await apiUsersIdpersonGet({
                path: { id: personId },
            });
            if (!personResponse.error) {
                person = personResponse.data;
            }
        }
    }
} catch (error) {
    console.error("Error fetching user:", error);
    errorMessage = t("profile.notFound");
}

// Prepare profile data
const displayName = user?.displayName || user?.handle || "User";
const location = "Barcelona, Catalunya"; // This would come from user data (e.g., user.location)

// Sample bio text - in production this would come from user data
const bio = displayName !== "User"
    ? `${displayName}: Innovador Social y Arquitecto de Comunidades Sostenibles.

Con más de 15 años de trayectoria en el ecosistema sin ánimo de lucro, ${displayName} se ha consolidado como un referente en la creación de redes colaborativas y la movilización de recursos a través del crowdfunding. Su visión se centra en potenciar iniciativas de base que transforman realidades locales, combinando estrategias de financiación colectiva con un profundo compromiso por la justicia social y la participación ciudadana. Como pilar activo de Goteo Foundation, ${displayName} impulsa proyectos que priorizan la transparencia radical, la sostenibilidad ambiental y la equidad. Su metodología va más allá de la recaudación: fomenta ecosistemas resilientes donde emprendedores sociales, artistas y agentes de cambio acceden no solo a fondos, sino también a mentorías, redes de contactos y herramientas para escalar su impacto. Bajo su liderazgo, iniciativas en áreas como economía circular, cultura libre y tecnología cívica han florecido en España, Latinoamérica y Europa.`
    : undefined;

const tabs = [
    { id: "about", label: t("profile.tabs.about") },
    { id: "projects", label: t("profile.tabs.projects") },
    { id: "donorType", label: t("profile.tabs.donorType") },
];

// Social links - these would come from user data (e.g., user.socialMedia)
// For now using sample data to demonstrate functionality
const socialLinks = {
    twitter: "https://twitter.com/example",
    instagram: "https://instagram.com/example",
    facebook: "https://facebook.com/example",
    linkedin: "https://linkedin.com/in/example",
    email: "mailto:example@email.com",
    medium: "https://medium.com/@example",
};

// Use placehold.co for cover if no avatar exists
const coverImage = user?.avatar
    ? undefined // Use default cover
    : undefined; // Will use ProfileHero's default

const avatarImage = user?.avatar || undefined; // Will use ProfileHero's default
---

<Layout
    title={`${displayName} - ${t("metadata.title")}`}
    description={`${t("profile.tabs.about")} ${displayName}`}
>
    {
        errorMessage ? (
            <div class="flex min-h-screen items-center justify-center">
                <p class="text-xl text-[#575757]">{errorMessage}</p>
            </div>
        ) : (
            <div class="flex w-full flex-col items-center gap-10">
                {/* Hero Section with Cover and Avatar */}
                <ProfileHero coverImage={coverImage} avatarImage={avatarImage} />

                {/* User Info Section */}
                <ProfileInfo
                    displayName={displayName}
                    location={location}
                    socialLinks={socialLinks}
                    client:load
                />

                {/* Tabs Navigation */}
                <div class="mt-8 w-full">
                    <ProfileTabs tabs={tabs} client:load />
                </div>

                {/* Bio Section */}
                <ProfileBio bio={bio} />
            </div>
        )
    }
</Layout>